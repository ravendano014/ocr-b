<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector de Documentos de Identidad</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .camera-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .results-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #camera {
            width: 100%;
            height: auto;
            background-color: #eee;
            border-radius: 4px;
        }
        #canvas {
            display: none;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        .selectors {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .data-field {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .data-field strong {
            display: inline-block;
            width: 150px;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
        .success {
            color: green;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Lector de Documentos de Identidad</h1>
    
    <div class="container">
        <div class="camera-section">
            <div class="selectors">
                <select id="cameraSelect"></select>
                <button id="startButton">Iniciar Cámara</button>
                <button id="captureButton" disabled>Capturar Documento</button>
            </div>
            <video id="camera" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            <div id="cameraStatus" class="error">Cámara no iniciada</div>
        </div>
        
        <div class="results-section">
            <h2>Datos Extraídos</h2>
            <div class="data-field">
                <strong>Tipo de Documento:</strong> <span id="docType">-</span>
            </div>
            <div class="data-field">
                <strong>Número:</strong> <span id="docNumber">-</span>
            </div>
            <div class="data-field">
                <strong>Apellidos:</strong> <span id="lastName">-</span>
            </div>
            <div class="data-field">
                <strong>Nombres:</strong> <span id="firstName">-</span>
            </div>
            <div class="data-field">
                <strong>Nacionalidad:</strong> <span id="nationality">-</span>
            </div>
            <div class="data-field">
                <strong>Fecha de Nacimiento:</strong> <span id="birthDate">-</span>
            </div>
            <div class="data-field">
                <strong>Sexo:</strong> <span id="gender">-</span>
            </div>
            <div class="data-field">
                <strong>Fecha de Expedición:</strong> <span id="issueDate">-</span>
            </div>
            <div class="data-field">
                <strong>Fecha de Vencimiento:</strong> <span id="expiryDate">-</span>
            </div>
            <div id="resultStatus"></div>
        </div>
    </div>

    <!-- Bibliotecas para procesamiento de imágenes y OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf417@0.8.0/dist/pdf417.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <script>
        // Variables globales
        let stream = null;
        let selectedDeviceId = null;
        const video = document.getElementById('camera');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const cameraSelect = document.getElementById('cameraSelect');
        const startButton = document.getElementById('startButton');
        const captureButton = document.getElementById('captureButton');
        const cameraStatus = document.getElementById('cameraStatus');
        const resultStatus = document.getElementById('resultStatus');

        // Evento al cargar la página
        window.addEventListener('DOMContentLoaded', () => {
            enumerateCameras();
        });

        // Enumerar cámaras disponibles
        async function enumerateCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                if (videoDevices.length === 0) {
                    cameraStatus.textContent = "No se encontraron cámaras";
                    return;
                }
                
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Cámara ${index + 1}`;
                    cameraSelect.appendChild(option);
                });
                
                selectedDeviceId = videoDevices[0].deviceId;
            } catch (err) {
                cameraStatus.textContent = `Error al acceder a las cámaras: ${err.message}`;
                cameraStatus.className = 'error';
            }
        }

        // Cambiar cámara seleccionada
        cameraSelect.addEventListener('change', () => {
            selectedDeviceId = cameraSelect.value;
        });

        // Iniciar cámara
        startButton.addEventListener('click', async () => {
            try {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                const constraints = {
                    video: {
                        deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined,
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment'
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                captureButton.disabled = false;
                cameraStatus.textContent = "Cámara iniciada correctamente";
                cameraStatus.className = 'success';
            } catch (err) {
                cameraStatus.textContent = `Error al iniciar la cámara: ${err.message}`;
                cameraStatus.className = 'error';
            }
        });

        // Capturar imagen y procesar
        captureButton.addEventListener('click', async () => {
            if (!stream) return;
            
            // Ajustar canvas al tamaño del video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            resultStatus.textContent = "Procesando documento...";
            resultStatus.className = '';
            
            try {
                // Extraer datos del documento
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // 1. Intentar leer código PDF417 (IDE302)
                const pdf417Result = await scanPDF417(imageData);
                if (pdf417Result) {
                    displayPDF417Data(pdf417Result);
                    resultStatus.textContent = "Datos extraídos correctamente (PDF417)";
                    resultStatus.className = 'success';
                    return;
                }
                
                // 2. Intentar leer MRZ (Zona legible por máquina)
                const mrzResult = await scanMRZ(imageData);
                if (mrzResult) {
                    displayMRZData(mrzResult);
                    resultStatus.textContent = "Datos extraídos correctamente (MRZ)";
                    resultStatus.className = 'success';
                    return;
                }
                
                // 3. Intentar OCR en áreas específicas (OCR-B)
                const ocrResult = await performOCR(imageData);
                if (ocrResult) {
                    displayOCRData(ocrResult);
                    resultStatus.textContent = "Datos extraídos correctamente (OCR)";
                    resultStatus.className = 'success';
                    return;
                }
                
                resultStatus.textContent = "No se pudo leer ningún dato del documento";
                resultStatus.className = 'error';
            } catch (err) {
                resultStatus.textContent = `Error al procesar documento: ${err.message}`;
                resultStatus.className = 'error';
                console.error(err);
            }
        });

        // Función para escanear código PDF417
        async function scanPDF417(imageData) {
            try {
                // Usamos jsQR que también puede leer algunos códigos PDF417
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (!code) return null;
                
                // Parsear datos específicos de IDE302
                if (code.data.startsWith("@")) {
                    return parseIDE302(code.data);
                }
                
                return null;
            } catch (err) {
                console.error("Error al leer PDF417:", err);
                return null;
            }
        }

        // Parsear formato IDE302 (PDF417)
        function parseIDE302(data) {
            const lines = data.split('\n');
            if (lines.length < 3) return null;
            
            // Ejemplo de estructura IDE302:
            // @
            // ANI<<ALVARO<<<<<<<<<<<<<<<<<<<<<<<<<<<
            // 12345678A5ESP7601011M1801015<<<<<<<<2
            
            const result = {};
            
            // Línea 2: Apellidos y nombres
            const nameLine = lines[1];
            const nameParts = nameLine.split('<<');
            result.lastName = nameParts[0].substring(5); // Quitar los primeros 5 caracteres (ej. "ANI<<")
            result.firstName = nameParts[1].replace(/</g, '').trim();
            
            // Línea 3: Datos personales
            const dataLine = lines[2];
            result.docNumber = dataLine.substring(0, 9).replace(/</g, '');
            result.nationality = dataLine.substring(10, 13);
            
            // Fecha de nacimiento (YYMMDD)
            const birthDateStr = dataLine.substring(13, 19);
            result.birthDate = `19${birthDateStr.substring(0, 2)}-${birthDateStr.substring(2, 4)}-${birthDateStr.substring(4, 6)}`;
            
            result.gender = dataLine.substring(20, 21);
            
            // Fecha de vencimiento (YYMMDD)
            const expiryDateStr = dataLine.substring(21, 27);
            result.expiryDate = `20${expiryDateStr.substring(0, 2)}-${expiryDateStr.substring(2, 4)}-${expiryDateStr.substring(4, 6)}`;
            
            result.docType = "Documento Nacional de Identidad";
            
            return result;
        }

        // Función para escanear MRZ
        async function scanMRZ(imageData) {
            try {
                // Usar Tesseract.js para OCR en la zona MRZ
                const { data: { text } } = await Tesseract.recognize(
                    imageData,
                    'eng',
                    { 
                        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<', 
                        preserve_interword_spaces: true 
                    }
                );
                
                if (!text) return null;
                
                // Buscar líneas MRZ (generalmente 2 o 3 líneas con caracteres especiales)
                const lines = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 20 && (line.includes('<') || /[0-9]/.test(line)));
                
                if (lines.length < 2) return null;
                
                return parseMRZ(lines);
            } catch (err) {
                console.error("Error al leer MRZ:", err);
                return null;
            }
        }

        // Parsear MRZ (para pasaportes y documentos de identidad)
        function parseMRZ(lines) {
            const result = {};
            
            // Determinar tipo de documento por la primera línea
            if (lines[0].startsWith('P<')) {
                result.docType = "Pasaporte";
                return parsePassportMRZ(lines, result);
            } else {
                result.docType = "Documento de Identidad";
                return parseIDCardMRZ(lines, result);
            }
        }

        // Parsear MRZ de pasaporte
        function parsePassportMRZ(lines, result) {
            // Primera línea
            const line1 = lines[0];
            const country = line1.substring(2, 5);
            
            // Segunda línea
            const line2 = lines[1];
            result.docNumber = line2.substring(0, 9).replace(/</g, '');
            result.nationality = country;
            
            // Fecha de nacimiento (YYMMDD)
            const birthDateStr = line2.substring(13, 19);
            result.birthDate = `19${birthDateStr.substring(0, 2)}-${birthDateStr.substring(2, 4)}-${birthDateStr.substring(4, 6)}`;
            
            result.gender = line2.substring(20, 21);
            
            // Fecha de vencimiento (YYMMDD)
            const expiryDateStr = line2.substring(21, 27);
            result.expiryDate = `20${expiryDateStr.substring(0, 2)}-${expiryDateStr.substring(2, 4)}-${expiryDateStr.substring(4, 6)}`;
            
            // Nombre (puede estar en la primera línea)
            const nameParts = line1.split('<<');
            result.lastName = nameParts[0].substring(5).replace(/</g, '');
            result.firstName = nameParts[1] ? nameParts[1].replace(/</g, ' ') : '';
            
            return result;
        }

        // Parsear MRZ de documento de identidad
        function parseIDCardMRZ(lines, result) {
            // Suponemos formato de 2 líneas
            const line1 = lines[0];
            const line2 = lines[1];
            
            result.docNumber = line1.substring(0, 9).replace(/</g, '');
            
            // Fecha de nacimiento (YYMMDD)
            const birthDateStr = line1.substring(13, 19);
            result.birthDate = `19${birthDateStr.substring(0, 2)}-${birthDateStr.substring(2, 4)}-${birthDateStr.substring(4, 6)}`;
            
            result.gender = line1.substring(20, 21);
            
            // Fecha de vencimiento (YYMMDD)
            const expiryDateStr = line1.substring(21, 27);
            result.expiryDate = `20${expiryDateStr.substring(0, 2)}-${expiryDateStr.substring(2, 4)}-${expiryDateStr.substring(4, 6)}`;
            
            // Nacionalidad
            result.nationality = line1.substring(10, 13);
            
            // Nombre
            const nameParts = line2.split('<<');
            result.lastName = nameParts[0].replace(/</g, ' ');
            result.firstName = nameParts[1] ? nameParts[1].replace(/</g, ' ') : '';
            
            return result;
        }

        // Función para realizar OCR en áreas específicas (OCR-B)
        async function performOCR(imageData) {
            try {
                // Recortar áreas específicas para OCR (ajustar según necesidades)
                const areas = {
                    docNumber: { x: 0.2, y: 0.1, width: 0.3, height: 0.05 },
                    lastName: { x: 0.2, y: 0.2, width: 0.6, height: 0.05 },
                    firstName: { x: 0.2, y: 0.25, width: 0.6, height: 0.05 },
                    birthDate: { x: 0.2, y: 0.35, width: 0.2, height: 0.05 },
                    expiryDate: { x: 0.5, y: 0.35, width: 0.2, height: 0.05 }
                };
                
                const result = { docType: "Documento de Identidad" };
                
                // Procesar cada área
                for (const [field, area] of Object.entries(areas)) {
                    const { x, y, width, height } = area;
                    const cropped = cropImageData(imageData, x, y, width, height);
                    
                    const { data: { text } } = await Tesseract.recognize(
                        cropped,
                        'spa',
                        { 
                            tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789/- ', 
                            preserve_interword_spaces: true 
                        }
                    );
                    
                    result[field] = text.trim();
                }
                
                return result;
            } catch (err) {
                console.error("Error en OCR:", err);
                return null;
            }
        }

        // Función para recortar ImageData
        function cropImageData(imageData, x, y, width, height) {
            const cropX = Math.floor(x * imageData.width);
            const cropY = Math.floor(y * imageData.height);
            const cropWidth = Math.floor(width * imageData.width);
            const cropHeight = Math.floor(height * imageData.height);
            
            const croppedData = new Uint8ClampedArray(cropWidth * cropHeight * 4);
            
            for (let i = 0; i < cropHeight; i++) {
                for (let j = 0; j < cropWidth; j++) {
                    const srcPos = ((cropY + i) * imageData.width + (cropX + j)) * 4;
                    const dstPos = (i * cropWidth + j) * 4;
                    
                    croppedData[dstPos] = imageData.data[srcPos];
                    croppedData[dstPos + 1] = imageData.data[srcPos + 1];
                    croppedData[dstPos + 2] = imageData.data[srcPos + 2];
                    croppedData[dstPos + 3] = imageData.data[srcPos + 3];
                }
            }
            
            return new ImageData(croppedData, cropWidth, cropHeight);
        }

        // Mostrar datos de PDF417
        function displayPDF417Data(data) {
            document.getElementById('docType').textContent = data.docType || '-';
            document.getElementById('docNumber').textContent = data.docNumber || '-';
            document.getElementById('lastName').textContent = data.lastName || '-';
            document.getElementById('firstName').textContent = data.firstName || '-';
            document.getElementById('nationality').textContent = data.nationality || '-';
            document.getElementById('birthDate').textContent = data.birthDate || '-';
            document.getElementById('gender').textContent = data.gender || '-';
            document.getElementById('expiryDate').textContent = data.expiryDate || '-';
        }

        // Mostrar datos de MRZ
        function displayMRZData(data) {
            document.getElementById('docType').textContent = data.docType || '-';
            document.getElementById('docNumber').textContent = data.docNumber || '-';
            document.getElementById('lastName').textContent = data.lastName || '-';
            document.getElementById('firstName').textContent = data.firstName || '-';
            document.getElementById('nationality').textContent = data.nationality || '-';
            document.getElementById('birthDate').textContent = data.birthDate || '-';
            document.getElementById('gender').textContent = data.gender || '-';
            document.getElementById('expiryDate').textContent = data.expiryDate || '-';
        }

        // Mostrar datos de OCR
        function displayOCRData(data) {
            document.getElementById('docType').textContent = data.docType || '-';
            document.getElementById('docNumber').textContent = data.docNumber || '-';
            document.getElementById('lastName').textContent = data.lastName || '-';
            document.getElementById('firstName').textContent = data.firstName || '-';
            document.getElementById('birthDate').textContent = data.birthDate || '-';
            document.getElementById('expiryDate').textContent = data.expiryDate || '-';
        }
    </script>
</body>
</html>
